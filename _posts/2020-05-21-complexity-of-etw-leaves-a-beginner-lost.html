---
layout: post
title: Complexity Of ETW Leaves A Beginner Lost
date: 2020-05-21 12:30:57.000000000 +00:00
type: post
post_id: '21560'
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Investigations
tags:
- ETW
- Logging
- UWP
meta:
  _thumbnail_id: '21561'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  timeline_notification: '1590089481'
  _publicize_job_id: '44530381247'
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 13:27:12'
author:
  login: inkarc
  email: luxo.lamp@gmail.com
  display_name: Roger Cheng
  first_name: Roger
  last_name: Cheng
permalink: "/2020/05/21/complexity-of-etw-leaves-a-beginner-lost/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body>
<p>When experimenting with something new in programming, it's always useful to step through the code in a debugger the first time to see what it does. An unfortunate side effect is far slower than normal execution speed, which <a href="https://newscrewdriver.com/2020/05/20/what-to-do-when-await-waits-too-long/">interferes with timing-sensitive operations</a>. An alternative is to have a logging mechanism that doesn't slow things down (as much) so we can read the logs afterwards to understand the sequence of events.</p>
<p>Windows has something called Event Tracing for Windows (ETW) that has evolved over the decades. This mechanism is implemented in the Windows kernel and offers dynamic control of what events to log. The mechanism itself was built to be lean, impacting system performance as little as possible while logging. The goal is that it is so fast and efficient that it barely affects timing-sensitive operations. Because one of the primary purposes of ETW is to diagnose system performance issues, and obviously it can't be useful it if running ETW itself causes severe slowdowns.</p>
<p>ETW infrastructure is exposed to Universal Windows Platform applications via the <a href="https://docs.microsoft.com/en-us/uwp/api/windows.foundation.diagnostics"><code>Windows.Foundation.Diagnostics</code></a> namespace, with utility classes that sounded simple enough at first glance: we create a logging session, we establish one or more channels within that session, and we log individual activities to a channel.</p>
<p>Trying to see how it works, though, can be overwhelming to the beginner. All I wanted is a timestamp and a text message, and optionally an indicator of importance of the message. The timestamp is automatic in ETW. The text message can be done with <a href="https://docs.microsoft.com/en-us/uwp/api/windows.foundation.diagnostics.loggingactivity.logevent"><code>LogEvent</code></a>, and I can pass in a <a href="https://docs.microsoft.com/en-us/uwp/api/windows.foundation.diagnostics.logginglevel"><code>LoggingLevel</code></a> to signify if it is verbose chatter, informative message, warning, error, or a critical event.</p>
<p>In the UWP sample library there is <a href="https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/Logging">a logging sample application</a> showcasing use of these logging APIs. The source code looks straightforward, and I was able to compile and run it. The problem came when trying to read this log: as part of its low-overhead goal and powerful complexity, the output of ETW is not a simple log file I can browse through. It is a task-specific ETL file format that requires its own applications to read. Such tools are part of the <a href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/">Windows Performance Toolkit</a>, but fortunately I didn't have to download and install the whole thing. The <a href="https://www.microsoft.com/en-us/p/windows-performance-analyzer/9n0w1b2bxgnz">Windows Performance Analyzer</a> can be installed by itself from the Windows store.</p>
<p>I opened up the ETL file generated by the sample app and... got no further. I could get a timeline of the application, and I can unfold a long list of events. But while I could get a timestamp for each event, I can't figure out how to retrieve messages. The sample application called <code>LogEvent</code> with a chunk of "Lorem ipsum" text, and I could not figure out how to retrieve it.</p>
<p>Long term I would love to know how to leverage the ETW infrastructure for my own application development and diagnosis. But after spending too much time unable to perform a very basic logging task, I shelved ETW for later and wrote my own <a href="https://newscrewdriver.com/2020/05/22/simple-logging-to-text-file/">simple logger that outputs to a plain text file</a>.</p>
<p></body></html></p>
