---
layout: post
title: 'Notes Of A Three.js Beginner: QuaternionKeyframeTrack Struggles'
date: 2021-05-16 12:30:00.000000000 +00:00
type: post
post_id: '26591'
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Programming Languages
tags:
- Composite Video
- ESP_8_BIT
- HTML
- JavaScript
- NTSC
- RGB332
- Three.js
meta:
  _last_editor_used_jetpack: block-editor
  _thumbnail_id: '26546'
  _oembed_66285521ef37dba78420fb59c9f854cd: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_66285521ef37dba78420fb59c9f854cd: '1621301848'
  _publicize_job_id: '58438489984'
  timeline_notification: '1621193469'
  _oembed_8616ef2553381b5edf40b13d8189a1bf: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_8616ef2553381b5edf40b13d8189a1bf: '1621193469'
  _oembed_ccbbc499a1bef34822db688cee1bdc6b: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_ccbbc499a1bef34822db688cee1bdc6b: '1621193470'
  _oembed_68508ae5841776f2d3e784638d40f3a4: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_68508ae5841776f2d3e784638d40f3a4: '1621193472'
  _oembed_5706c5561a4dd0d7f7504a0291a785e8: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="420" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_5706c5561a4dd0d7f7504a0291a785e8: '1622231203'
  _oembed_d310d482de38727d0feb03f373572a9a: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">My
    interactive RGB332 8-bit color picker can now be toggled between HSV cylinder
    and RGB cube modes. Half of the cubes (green-yellow) aren&#39;t doing what I want
    because I clearly don&#39;t understand quaternions. Still a nifty animation, though.
    <a href="https://t.co/jtRMMVNboP">pic.twitter.com/jtRMMVNboP</a></p>&mdash; Roger
    Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1388265529228480512?ref_src=twsrc%5Etfw">April
    30, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_d310d482de38727d0feb03f373572a9a: '1708471185'
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 13:29:52'
author:
  login: inkarc
  email: luxo.lamp@gmail.com
  display_name: Roger Cheng
  first_name: Roger
  last_name: Cheng
permalink: "/2021/05/16/notes-of-a-three-js-beginner-quaternionkeyframetrack-struggles/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>When I started researching how to programmatically animate object rotations in three.js, I was warned that quaternions are hard to work with and can easily bamboozle beginners. I gave it a shot anyway, and I can confirm caution is indeed warranted. Aside from my <a href="https://newscrewdriver.com/2021/05/15/notes-of-a-three-js-beginner-euler-angles-vs-quaternions/">confusion between Euler angles and quaternions</a>, I was also ignorant of how three.js keyframe track objects process their data arrays. Constructor of keyframe track objects like <code>QuaternionKeyframeTrack</code> accept (as their third parameter) an array of key values. I thought it would obviously be an array of quaternions like <code>[quaterion1, quaternion2]</code>, but when I did that, my CPU utilization shot to 100% and the browser stopped responding. Using the browser debugger, I saw it was stuck in this for() loop:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code {"fontSize":"small"} --></p>
<pre class="wp-block-code has-small-font-size"><code>class QuaternionLinearInterpolant extends Interpolant {
  constructor(parameterPositions, sampleValues, sampleSize, resultBuffer) {
    super(parameterPositions, sampleValues, sampleSize, resultBuffer);
  }
  interpolate_(i1, t0, t, t1) {
    const result = this.resultBuffer, values = this.sampleValues, stride = this.valueSize, alpha = (t - t0) / (t1 - t0);
    let offset = i1 * stride;
    <strong><span class="has-inline-color has-vivid-red-color">for (let end = offset + stride; offset !== end; offset += 4)</span></strong> {
      Quaternion.slerpFlat(result, 0, values, offset - stride, values, offset, alpha);
    }
    return result;
  }
}</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p>I only have two quaterions in my key frame values, but it is stepping through in increments of 4. So this for() loop immediately shot past end and kept looping. The fact it was stepping by four instead of by one was the key clue. This class doesn't want an array of quaternions, it wants an array of quaternion numerical fields flattened out.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Wrong: <code>[quaterion1, quaternion2]</code>
</li>
<li>Right: <code>[quaterion1.x, quaterion1.y, quaterion1.z, quaterion1.w, quaternion2.x, quaternion2.y, quaternion2.z, quaternion2.w]</code>
</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>The latter can also be created via <code>quaterion1.toArray().concat(quaternion2.toArray())</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Once I got past that hurdle, I had an animation on screen. But only half of the colors animated in the way I wanted. The other half of the colors went in the opposite direction while swerving wildly on screen. In a HSV cylinder, colors are rotated across the full range of 360 degrees. When I told them to all go to zero in the transition to a cube, the angles greater than 180 went one direction and the angles less than 180 went the opposite direction.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Having this understanding of the behavior, however, wasn't much help in trying to get things working the way I had it in my head. I'm sure there are some amateur hour mistakes causing me grief but after several hours of ever-crazier animations, I surrendered and settled for hideous hacks. Half of the colors still behaved differently from the other half, but at least they don't fly wildly across the screen. It is unsatisfactory but will have to suffice for now. I obviously don't understand quaternions and need to study up before I can make this thing work the way I intended. But that's for later, because this was originally supposed to be a side quest to the main objective: the Arduino color composite video out library I've released with <a href="https://newscrewdriver.com/2021/05/17/overriding-adafruit-gfx-hline-vline-defaults-for-performance/">known problems I should fix</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https:\/\/twitter.com\/Regorlas\/status\/1388265529228480512","type":"rich","providerNameSlug":"twitter","responsive":true} --></p>
<figure class="wp-block-embed is-type-rich is-provider-twitter wp-block-embed-twitter">
<div class="wp-block-embed__wrapper">
https://twitter.com/Regorlas/status/1388265529228480512
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph {"align":"center"} --></p>
<p class="has-text-align-center"> [Code for this project is <a rel="noreferrer noopener" href="https://github.com/Roger-random/RGB332_color_wheel_three.js" target="_blank">publicly available on GitHub</a>]</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
