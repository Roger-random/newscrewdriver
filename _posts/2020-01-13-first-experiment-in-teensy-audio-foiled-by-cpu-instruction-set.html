---
layout: post
title: First Experiment in Teensy Audio Foiled By CPU Instruction Set
date: 2020-01-13 12:30:45.000000000 +00:00
type: post
post_id: '20228'
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Hardware Platforms
- Projects
tags:
- Teensy
meta:
  _thumbnail_id: '20233'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '39506900866'
  timeline_notification: '1578947508'
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 13:26:03'
author:
  login: inkarc
  email: luxo.lamp@gmail.com
  display_name: Roger Cheng
  first_name: Roger
  last_name: Cheng
permalink: "/2020/01/13/first-experiment-in-teensy-audio-foiled-by-cpu-instruction-set/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body></p>
<p>The original line of Arduino boards are know for a lot of very flexible features that made them the champion of entry into physical computing. "Large storage space" is not one of those features, as the <a href="https://www.microchip.com/wwwproducts/en/ATmega328p">ATmega328P has only 32KB of flash</a>. Plenty for blinking little LEDs and a <a href="https://newscrewdriver.com/2019/04/28/i-found-my-motivation-to-enter-world-of-arduino-make-sawppy-easier/">great many other projects</a>, severely limiting for anything that requires nontrivial amount of data.</p>
<p>One such class of projects is playing back digital audio samples. Simple sounds like tones, beeps, and bloops take little data, but recorded digital audio consumes a great many bytes. I was introduced to the <a href="https://github.com/sensorium/Mozzi">Mozzi</a> Arduino sound synthesis library via exposure to Emily's projects. While the emphasis is on synthesis, it does have provision to handle sampled audio. However, due to the small flash storage, <a href="https://github.com/sensorium/Mozzi/blob/master/SampleHuffman.h">even with compression</a> it could only handle short sounds.</p>
<p>Looking around for an upgrade, I remembered I have a <a href="http://blog.oshpark.com/2016/05/14/teensy-lc-osh-park-edition/">Teensy LC OSH Park edition</a> I had purchased alongside an OSH Park order years ago and thought it was worth an audio playback experiment. The CPU is much faster and it has <a href="https://www.pjrc.com/teensy/teensyLC.html">almost double the flash storage</a>. Exploring the Arduino-compatibility layer called <a href="https://www.pjrc.com/teensy/teensyduino.html">Teensyduino</a>, I see it offers a full analog audio API, complete with <a href="https://www.pjrc.com/teensy/gui">a graphical tool to help compose the tree of audio input/processing/output nodes</a>. I was very impressed!</p>
<p>I decided to start small with just two nodes: sound is to be generated by playing from sampled audio data in memory, and sent to built-in DAC. Pressing "Export" generated the following boilerplate code:</p>
<blockquote><p>
<code>#include &lt;Audio.h&gt;</code><br />
<code>#include &lt;Wire.h&gt;</code><br />
<code>#include &lt;SPI.h&gt;</code><br />
<code>#include &lt;SD.h&gt;</code><br />
<code>#include &lt;SerialFlash.h&gt;</code></p>
<p><code>// GUItool: begin automatically generated code</code><br />
<code>AudioPlayMemory playMem1; //xy=262,658</code><br />
<code>AudioOutputAnalog dac1; //xy=436,657</code><br />
<code>AudioConnection patchCord1(playMem1, dac1);</code><br />
<code>// GUItool: end automatically generated code</code></p>
<p><code>void setup() {</code><br />
<code>// put your setup code here, to run once:</code></p>
<p><code>}</code></p>
<p><code>void loop() {</code><br />
<code>// put your main code here, to run repeatedly:</code></p>
<p><code>}</code>
</p></blockquote>
<p>Sadly, this code did not compile. Instead, I encountered this error:</p>
<blockquote><p>
<code>/tmp/ccLBGUGU.s: Assembler messages:</code><br />
<code>/tmp/ccLBGUGU.s:291: Error: selected processor does not support `smull r0,ip,r3,r5' in Thumb mode</code><br />
<code>/tmp/ccLBGUGU.s:292: Error: shifts in CMP/MOV instructions are only supported in unified syntax -- `mov ip,ip,asl r6'</code><br />
<code>/tmp/ccLBGUGU.s:293: Error: unshifted register required -- `orr r0,ip,r0,lsr r7'</code>
</p></blockquote>
<p>A web search on this error message indicated this is because the chip on Teensy LC does not support the instructions described in the error message, I'd need a Teensy 3 or 4. To test this hypothesis, I changed the compiler to target Teensy 3 instead of LC and hit "Verify" again. This time, it was successful. But I don't have a Teensy 3 on hand, so I can't actually run that code.</p>
<p>Given this limitation I'll have to find some other project for my Teensy LC. In the meantime, I'll <a href="https://newscrewdriver.com/2020/01/14/arduino-mozzi-space-core-exercise/">drop back to the tried and true Arduino for my Mozzi exercise</a>.</body></html></p>
