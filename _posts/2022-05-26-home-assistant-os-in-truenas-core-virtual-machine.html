---
layout: post
title: Home Assistant OS in TrueNAS CORE Virtual Machine
date: 2022-05-26 12:30:00.000000000 +00:00
type: post
post_id: '30482'
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Projects
tags:
- Home Assistant
- TrueNAS
meta:
  _last_editor_used_jetpack: block-editor
  _thumbnail_id: '30489'
  _publicize_job_id: '72971776573'
  timeline_notification: '1653593412'
  wordads_ufa: s:wpcom-ufa-v3-beta:1664613239
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 13:31:52'
author:
  login: inkarc
  email: luxo.lamp@gmail.com
  display_name: Roger Cheng
  first_name: Roger
  last_name: Cheng
permalink: "/2022/05/26/home-assistant-os-in-truenas-core-virtual-machine/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>I started <a href="https://newscrewdriver.com/2022/02/19/notes-on-home-assistant-core-vs-home-assistant-operating-system/">playing with Home Assistant</a> in the form of <em>Home Assistant Core</em>, a docker container, for its low commitment. Once I decided Home Assistant was worthwhile, I moved up to running <em>Home Assistant Operating System</em> as a virtual machine on my <a rel="noreferrer noopener" href="https://www.truenas.com/truenas-core/" target="_blank">TrueNAS CORE</a> server. This move gained features of <a href="https://developers.home-assistant.io/docs/supervisor/">Home Assistant Supervisor</a> and I found the following subset quite useful:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Easy upgrade and rollback for failed upgrades.</li>
<li>Add-on integration features, especially for ESPHome.</li>
<li>Ability to backup critical data in a compact *.tar file.</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>The backup situation is a tradeoff. When I ran Home Assistant Core docker container, I could map its data directory to my TrueNAS storage pool. It was a more robust data retention system, as I had configured it for nightly snapshots and regular backups to external media. However, this would take upwards of hundreds of megabytes especially when I'm <a href="https://newscrewdriver.com/2022/02/24/esphome-sensor-filters-help-manage-flood-of-data/">flooding the Home Assistant database</a>. In contrast, the data backup archive generated by Home Assistant Supervisor is tiny at only a few megabytes. I have ambition to eventually get the best of both worlds: a Home Assistant automation that triggers Supervisor backups, and then store those backup files on my TrueNAS storage pool. This should be possible, as people have created addons to <a href="https://community.home-assistant.io/t/add-on-home-assistant-google-drive-backup">perform automatic backups and upload to Google Drive</a>. But right now I have to do it manually.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Unrelated to the backup situation, there were two significant downsides to running Home Assistant OS on a TrueNAS CORE virtual machine.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list {"ordered":true} --></p>
<ol>
<li>The virtual machine does not have access to hardware. If ESPHome add-on could access USB, it could <a rel="noreferrer noopener" href="https://esphome.io/guides/physical_device_connection.html" target="_blank">perform first-time firmware upload</a> on ESP32/ESP8266 devices. Without hardware access, I have to perform initial upload some other way which is cumbersome. (Following uploads could be done via WiFi, a huge benefit of ESPHome.)</li>
<li>There are various problems with the FreeBSD bhyve hypervisor running Linux-based operating systems. A category of them (apparently there are more than one) interferes with the ability for a Linux operating system to reboot itself. In practice, this means every time the Home Assistant OS updates itself and reboots, it would shut down but not restart. At one point, I could not perform manual shutdown from TrueNAS interface, so the horrible workaround was to reboot my TrueNAS server. After a few TrueNAS updates, I can now manually shut down and restart the VM. But it is still a big hassle to do this on every Home Assistant OS update.</li>
</ol>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Due to these problems, I would NOT recommend running Home Assistant OS as a TrueNAS CORE virtual machine. Issue #2 became quite annoying and, when my Home Assistant got stuck trying to reboot for an upgrade to Home Assistant OS 8.0, I decided it was time to <a href="https://newscrewdriver.com/2022/05/27/home-assistant-os-in-kvm-hypervisor/">try a different setup</a>.</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
