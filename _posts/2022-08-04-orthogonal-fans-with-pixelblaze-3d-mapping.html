---
layout: post
title: Orthogonal Fans with Pixelblaze 3D Mapping
date: 2022-08-04 12:30:00.000000000 +00:00
type: post
post_id: '31792'
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Projects
tags:
- Asiahorse
- Cooling Fan
- LED
- Pixelblaze
meta:
  _last_editor_used_jetpack: block-editor
  _oembed_e1225d32d02547b94d4e0c4aecfbe365: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">Hacking
    on a trio of cheap PC case fans so <a href="https://twitter.com/hashtag/WS2812?src=hash&amp;ref_src=twsrc%5Etfw">#WS2812</a>
    <a href="https://twitter.com/hashtag/NeoPixel?src=hash&amp;ref_src=twsrc%5Etfw">#NeoPixel</a>
    LEDs embedded in each hub can be controlled using <a href="https://twitter.com/hashtag/Pixelblaze?src=hash&amp;ref_src=twsrc%5Etfw">#Pixelblaze</a>
    by <a href="https://twitter.com/ledmage?ref_src=twsrc%5Etfw">@ledmage</a>. Test
    here is running my X/Y/Z-axis sweep program to verify 3D coordinate map. <a href="https://t.co/wRkXu1fLiM">pic.twitter.com/wRkXu1fLiM</a></p>&mdash;
    Roger Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1548833121851752448?ref_src=twsrc%5Etfw">July
    18, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_e1225d32d02547b94d4e0c4aecfbe365: '1658602542'
  _thumbnail_id: '31793'
  _publicize_job_id: '75485813492'
  timeline_notification: '1659641599'
  _oembed_f02f6ebeb95ef0bf57745d3b1a9eeded: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Hacking
    on a trio of cheap PC case fans so <a href="https://twitter.com/hashtag/WS2812?src=hash&amp;ref_src=twsrc%5Etfw">#WS2812</a>
    <a href="https://twitter.com/hashtag/NeoPixel?src=hash&amp;ref_src=twsrc%5Etfw">#NeoPixel</a>
    LEDs embedded in each hub can be controlled using <a href="https://twitter.com/hashtag/Pixelblaze?src=hash&amp;ref_src=twsrc%5Etfw">#Pixelblaze</a>
    by <a href="https://twitter.com/ledmage?ref_src=twsrc%5Etfw">@ledmage</a>. Test
    here is running my X/Y/Z-axis sweep program to verify 3D coordinate map. <a href="https://t.co/wRkXu1fLiM">pic.twitter.com/wRkXu1fLiM</a></p>&mdash;
    Roger Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1548833121851752448?ref_src=twsrc%5Etfw">July
    18, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_f02f6ebeb95ef0bf57745d3b1a9eeded: '1659641605'
  _oembed_9cc2de19afef08414a61130fd0e386bb: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Hacking
    on a trio of cheap PC case fans so <a href="https://twitter.com/hashtag/WS2812?src=hash&amp;ref_src=twsrc%5Etfw">#WS2812</a>
    <a href="https://twitter.com/hashtag/NeoPixel?src=hash&amp;ref_src=twsrc%5Etfw">#NeoPixel</a>
    LEDs embedded in each hub can be controlled using <a href="https://twitter.com/hashtag/Pixelblaze?src=hash&amp;ref_src=twsrc%5Etfw">#Pixelblaze</a>
    by <a href="https://twitter.com/ledmage?ref_src=twsrc%5Etfw">@ledmage</a>. Test
    here is running my X/Y/Z-axis sweep program to verify 3D coordinate map. <a href="https://t.co/wRkXu1fLiM">pic.twitter.com/wRkXu1fLiM</a></p>&mdash;
    Roger Cheng (@Regorlas) <a href="https://twitter.com/Regorlas/status/1548833121851752448?ref_src=twsrc%5Etfw">July
    18, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_9cc2de19afef08414a61130fd0e386bb: '1708471243'
  _elasticsearch_data_sharing_indexed_on: '2024-11-18 13:32:34'
author:
  login: inkarc
  email: luxo.lamp@gmail.com
  display_name: Roger Cheng
  first_name: Roger
  last_name: Cheng
permalink: "/2022/08/04/orthogonal-fans-with-pixelblaze-3d-mapping/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>I have <a href="https://newscrewdriver.com/2022/08/03/control-board-for-asiahorse-120mm-fans-with-rgb-led/">built a control board</a> for a trio of affordable PC case fans, replacing their bundled control hub of this Asiahorse Magic-i 120 V2 system. With my board I can control individual RGB LED inside these fans with help of a <a rel="noreferrer noopener" href="https://electromage.com/pixelblaze" target="_blank">Pixelblaze LED controller</a>. My initial tests used simple built-in linear patterns, but I wanted to use patterns that take advantage of 3D coordinate mapping. This is my favorite part of Pixelblaze and a core part of my <a rel="noreferrer noopener" href="https://newscrewdriver.com/tag/glow-flow/" target="_blank">Glow Flow</a> project.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>To get a 3D structure out of three fans, I did the easiest and most expedient thing: orient them orthogonal to each other with a few twist-ties. Now every fan motor axis lines up with one of three axes in 3D space. I have a Pixelblaze 3D coordinate test program already in hand, the <a rel="noreferrer noopener" href="https://github.com/Roger-random/glowflow/blob/master/rgbxyz%20sweep" target="_blank">RGB-XYZ 3D Sweep</a> program I created during Glow Flow. All I had to do was <a rel="noreferrer noopener" href="https://electromage.com/intro_to_mapping" target="_blank">create a 3D coordinate map</a> in my Pixelblaze to describe LED layout in three-dimensional space.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>I opened up the Pixelblaze mapping editor and... immediately got stuck. Where, exactly, should I map these LEDs? Physically, they are surface mounted on the central hub. However, their light diffused by translucent fan blade plastic, no longer fixed to a single location but distributed across entire fan diameter. Should I map the LEDs where they are physically? Or fan blade outer perimeter? Or somewhere in between? There really isn't one single location for resulting output of a single LED.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"align":"center","id":31911,"sizeSlug":"large","linkDestination":"none"} --></p>
<figure class="wp-block-image aligncenter size-large"><img src="https://newscrewdriver.com/wp-content/uploads/2022/07/asiahorse-fan-diffused-led.jpg?w=1024" alt="" class="wp-image-31911"></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>I decided to experiment by writing my mapping code so a single variable controls how far from the center each location is. When <code>pixelRadius</code> is zero, everything is at the center and not very interesting. When set to 0.5, everything is mapped to the perimeter. I adjusted this value until the pattern "looked right" and that ended up at 0.4. I'm not satisfied with the empirical nature of this value, but I haven't figured out a better way to account for diffusion.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Another problem with these LEDs is that they weren't placed with precise coordinates in mind. I think LEDs were laid out on the circuit board relative to wiring bundle location, which is slightly offset from one of the four mounting arms. As a result, the LEDs aren't aligned to any reference point on the exterior. To use an analog clock face as example, these LEDs are evenly placed but slightly offset from the hour numbers. Instead of lined up at 12, 1, 2, 3. They are at 12:10, 1:10, 2:10, etc.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>These fans are physically squares with side lengths of 120mm. They can be installed in one of four orientations that are 90 degrees from each other and be mechanically fine. I usually choose my orientation based on whichever makes the wiring most convenient. But whatever the motivation, my 3D coordinate map would have to compensate for the resulting rotation.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The answer for both of the above rotation compensation concerns is an array <code>fanRotationCorrection</code>.  One value for each fan, a sum of physical and LED offset rotations (in radians) added into coordinate map angle calculation for that fan.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Here is the result of my 3D pixel map running my RGB-XYZ sweep test program:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://twitter.com/Regorlas/status/1548833121851752448","type":"rich","providerNameSlug":"twitter","responsive":true} --></p>
<figure class="wp-block-embed is-type-rich is-provider-twitter wp-block-embed-twitter">
<div class="wp-block-embed__wrapper">
https://twitter.com/Regorlas/status/1548833121851752448
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>Here is my Pixelblaze Pixel Mapper code. [UPDATE: I later noticed that I got my Z-axis backwards. Be aware that both the video embedded in the tweet and this pixel mapper code are known to be flawed. At least they're consistent with each other!]</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code {"style":{"typography":{"fontSize":"10px"}}} --></p>
<pre class="wp-block-code" style="font-size:10px;"><code>function(pixelCount) {
  pixelPerFan = 12;
  pixelRadius = 0.4;
  fanRotationCorrection = [0.65, 0.65, 0.65];

  var map = [];
  for (i = 0; i &lt; pixelCount; i++) {
    var ledNumber = i % pixelPerFan;
    var ledRadians = ((ledNumber/pixelPerFan) * Math.PI * 2);

    if (i &lt; pixelPerFan) {
      ledRadians += Math.PI*fanRotationCorrection[0]
      map.push([0, 0.5 + Math.cos(ledRadians)*pixelRadius, 0.5 - Math.sin(ledRadians)*pixelRadius]);
    } else if (i &lt; pixelPerFan*2) {
      ledRadians += Math.PI*fanRotationCorrection[1]
      map.push([0.5 - Math.cos(ledRadians)*pixelRadius, 0, 0.5 - Math.sin(ledRadians)*pixelRadius]);
    } else if (i &lt; pixelPerFan*3) {
      ledRadians += Math.PI*fanRotationCorrection[2]
      map.push([0.5 - Math.cos(ledRadians)*pixelRadius, 0.5 + Math.sin(ledRadians)*pixelRadius, 0]);
    } else {
      // Unexpected pixels are placed at origin
      map.push(0,0,0);
    }
  }
  return map;
}</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:separator --></p>
<hr class="wp-block-separator has-alpha-channel-opacity">
<!-- /wp:separator --></p>
<p><!-- wp:paragraph --></p>
<p>My Asiahorse investigation results were also <a rel="noreferrer noopener" href="https://forum.electromage.com/t/pixelblaze-for-rgb-led-pc-accessories/2349" target="_blank">posted to Pixelblaze forums</a>. And now that I have full and complete control over these fans, I <a href="https://newscrewdriver.com/2022/08/05/rgb-led-fan-hub-and-remote-asiahorse-magic-i-120-v2/">no longer need the hub that came in the box</a>.</p>
<p><!-- /wp:paragraph --><br />
</body></html></p>
